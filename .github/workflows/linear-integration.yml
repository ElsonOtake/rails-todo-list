# .github/workflows/linear-integration.yml
name: Linear Integration Workflow

# This workflow is triggered by repository dispatch events from Linear via n8n
on:
  repository_dispatch:
    types: 
      - linear_event           # Main event type from n8n
      - linear_issue_created   # When new issue is created
      - linear_issue_updated   # When issue is updated
      - linear_issue_completed # When issue is marked complete

jobs:
  # Job 1: Process issues with "Ready for Claude" label
  process-claude-ready:
    if: contains(github.event.client_payload.labels, 'Ready for Claude')
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Create refactoring branch
        id: create-branch
        run: |
          echo "📝 Processing Linear issue for Claude"
          echo "Issue: ${{ github.event.client_payload.title }}"
          echo "ID: ${{ github.event.client_payload.issueId }}"
          
          # Extract team prefix and create branch name
          TEAM="${{ github.event.client_payload.team }}"
          ISSUE_ID="${{ github.event.client_payload.issueId }}"
          # Take first 8 chars of UUID for shorter branch name
          SHORT_ID="${ISSUE_ID:0:8}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create branch name based on issue type
          if [[ "${{ toJson(github.event.client_payload.labels) }}" == *"Bug"* ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"bug"* ]]; then
            BRANCH_NAME="fix/${TEAM,,}-${SHORT_ID}"
          elif [[ "${{ toJson(github.event.client_payload.labels) }}" == *"feature"* ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"Feature"* ]]; then
            BRANCH_NAME="feature/${TEAM,,}-${SHORT_ID}"
          else
            BRANCH_NAME="refactor/${TEAM,,}-${SHORT_ID}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Create and checkout branch
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b "$BRANCH_NAME"
          
      - name: Generate Claude instructions
        run: |
          # Determine issue type and generate appropriate instructions
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          
          if [[ "$ISSUE_TYPE" == "bug" ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"Bug"* ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"bug"* ]]; then
            cat > refactoring-instructions.md << 'EOF'
          # 🐛 Bug Fix: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: ${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          
          ## Labels
          ${{ toJson(github.event.client_payload.labels) }}
          
          ## Bug Report
          
          ### Current Behavior
          ${{ github.event.client_payload.sections.currentBehavior }}
          
          ### Expected Behavior
          ${{ github.event.client_payload.sections.expectedBehavior }}
          
          ### Steps to Reproduce
          ${{ github.event.client_payload.sections.stepsToReproduce }}
          
          ### Technical Details
          - **Component**: ${{ github.event.client_payload.sections.component }}
          - **Browser/Environment**: ${{ github.event.client_payload.sections.environment }}
          - **Priority**: ${{ github.event.client_payload.sections.priority }}
          
          ### Proposed Solution
          ${{ github.event.client_payload.sections.proposedSolution }}
          
          ---
          
          ## Bug Fix Guidelines for Claude Code
          
          1. **Reproduce the Bug**
             - Follow the steps to reproduce
             - Verify the current behavior
             - Document any additional observations
          
          2. **Root Cause Analysis**
             - Identify the source of the bug
             - Check for related issues
             - Review recent changes that might have introduced it
          
          3. **Implementation**
             - Fix the root cause, not just symptoms
             - Ensure backward compatibility
             - Add defensive coding where appropriate
          
          4. **Testing**
             - Write tests that reproduce the bug
             - Ensure the fix resolves the issue
             - Add regression tests
             - Run full test suite
          
          5. **Verification**
             - Test the fix in development
             - Verify no new issues introduced
             - Check performance impact
          EOF
          
          elif [[ "$ISSUE_TYPE" == "feature" ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"feature"* ]]; then
            cat > refactoring-instructions.md << 'EOF'
          # ✨ Feature Implementation: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: ${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          
          ## Labels
          ${{ toJson(github.event.client_payload.labels) }}
          
          ## Feature Request
          
          ### Description
          ${{ github.event.client_payload.sections.description }}
          
          ### Requirements
          ${{ github.event.client_payload.sections.requirements }}
          
          ### Technical Details
          ${{ github.event.client_payload.sections.technicalDetails }}
          
          ### Acceptance Criteria
          ${{ github.event.client_payload.sections.acceptanceCriteria }}
          
          ---
          
          ## Feature Implementation Guidelines for Claude Code
          
          1. **Planning Phase**
             - Review all requirements thoroughly
             - Break down into smaller tasks
             - Identify dependencies
             - Plan the implementation approach
          
          2. **Architecture Design**
             - Design database schema if needed
             - Plan API endpoints
             - Consider security implications
             - Design for scalability
          
          3. **Implementation**
             - Follow Rails conventions
             - Implement incrementally
             - Write clean, maintainable code
             - Add proper error handling
          
          4. **Testing Strategy**
             - Write unit tests for all new code
             - Add integration tests for workflows
             - Test edge cases
             - Ensure acceptance criteria are met
          
          5. **Documentation**
             - Update API documentation
             - Add code comments for complex logic
             - Update README if needed
             - Document any new configurations
          EOF
          
          else
            # Default template for other types
            cat > refactoring-instructions.md << 'EOF'
          # Linear Issue: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: ${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          
          ## Labels
          ${{ toJson(github.event.client_payload.labels) }}
          
          ## Description
          ${{ github.event.client_payload.description }}
          
          ## Additional Information
          ${{ toJson(github.event.client_payload.sections) }}
          
          ---
          
          ## Implementation Guidelines for Claude Code
          
          1. **Analysis**
             - Review the requirements
             - Understand the context
             - Identify key objectives
          
          2. **Implementation**
             - Follow best practices
             - Write clean code
             - Ensure maintainability
          
          3. **Testing**
             - Add appropriate tests
             - Verify functionality
             - Check edge cases
          
          4. **Documentation**
             - Update relevant documentation
             - Add code comments
          EOF
          fi
          
          echo "✅ Created refactoring instructions"
          
      - name: Create Claude task file
        run: |
          cat > .claude-task.json << EOF
          {
            "source": "linear",
            "issueId": "${{ github.event.client_payload.issueId }}",
            "title": "${{ github.event.client_payload.title }}",
            "team": "${{ github.event.client_payload.team }}",
            "priority": ${{ github.event.client_payload.priority }},
            "estimate": ${{ github.event.client_payload.estimate }},
            "labels": ${{ toJson(github.event.client_payload.labels) }},
            "type": "${{ github.event.client_payload.sections.type }}",
            "url": "${{ github.event.client_payload.url }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "branch": "${{ steps.create-branch.outputs.branch_name }}",
            "instructions": {
              "currentBehavior": "${{ github.event.client_payload.sections.currentBehavior }}",
              "expectedBehavior": "${{ github.event.client_payload.sections.expectedBehavior }}",
              "stepsToReproduce": "${{ github.event.client_payload.sections.stepsToReproduce }}",
              "proposedSolution": "${{ github.event.client_payload.sections.proposedSolution }}",
              "description": "${{ github.event.client_payload.sections.description }}",
              "requirements": "${{ github.event.client_payload.sections.requirements }}",
              "technicalDetails": "${{ github.event.client_payload.sections.technicalDetails }}",
              "acceptanceCriteria": "${{ github.event.client_payload.sections.acceptanceCriteria }}"
            }
          }
          EOF
          
          echo "✅ Created Claude task file"
          
      - name: Commit and push branch
        run: |
          git add refactoring-instructions.md .claude-task.json
          git commit -m "Add Linear issue ${{ github.event.client_payload.issueId }} for Claude refactoring
          
          Issue: ${{ github.event.client_payload.title }}
          Team: ${{ github.event.client_payload.team }}
          Priority: P${{ github.event.client_payload.priority }}
          Labels: ${{ join(github.event.client_payload.labels, ', ') }}"
          
          git push origin ${{ steps.create-branch.outputs.branch_name }}
          
      - name: Create pull request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          PR_BODY="## Linear Issue: ${{ github.event.client_payload.title }}
          
          ### Details
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: P${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          
          ### Issue Type: ${{ github.event.client_payload.sections.type }}
          
          **Current Behavior**: ${{ github.event.client_payload.sections.currentBehavior }}
          
          **Expected Behavior**: ${{ github.event.client_payload.sections.expectedBehavior }}
          
          ### Next Steps
          1. Review the \`refactoring-instructions.md\` file
          2. Use Claude Code to implement the fix/refactor
          3. Ensure all tests pass
          4. Update this PR with your changes
          
          ---
          *This PR was automatically created from Linear issue ${{ github.event.client_payload.issueId }}*"
          
          PR_URL=$(gh pr create \
            --title "[${{ github.event.client_payload.team }}] ${{ github.event.client_payload.title }}" \
            --body "$PR_BODY" \
            --head ${{ steps.create-branch.outputs.branch_name }} \
            --base main \
            --label "linear-integration" \
            --label "needs-claude")
          
          echo "PR created: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
          # Extract PR number from URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Add Claude comment to PR
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Determine the appropriate message based on issue type
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          
          if [[ "$ISSUE_TYPE" == "bug" ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"Bug"* ]]; then
            COMMENT_BODY="@claude Fix this bug based on the issue description and the instructions in \`refactoring-instructions.md\`"
          elif [[ "$ISSUE_TYPE" == "feature" ]] || [[ "${{ toJson(github.event.client_payload.labels) }}" == *"feature"* ]]; then
            COMMENT_BODY="@claude Implement this feature based on the issue description and the requirements in \`refactoring-instructions.md\`"
          else
            COMMENT_BODY="@claude Implement this based on the issue description and the guidelines in \`refactoring-instructions.md\`"
          fi
          
          gh pr comment ${{ steps.create-pr.outputs.pr_number }} --body "$COMMENT_BODY"
          echo "✅ Added Claude comment to PR #${{ steps.create-pr.outputs.pr_number }}"

  # Job 2: Handle bug issues specifically
  handle-bugs:
    if: contains(github.event.client_payload.labels, 'Bug')
    runs-on: ubuntu-latest
    steps:
      - name: Process bug report
        run: |
          echo "🐛 Bug Report Received"
          echo "Title: ${{ github.event.client_payload.title }}"
          echo "Priority: P${{ github.event.client_payload.priority }}"
          echo "Team: ${{ github.event.client_payload.team }}"
          
          # Add bug-specific processing here
          # - Create bug tracking issue
          # - Notify team
          # - Run diagnostic tests
          
      - name: Check if critical bug
        if: github.event.client_payload.priority == 1
        run: |
          echo "⚠️ CRITICAL BUG DETECTED!"
          echo "Immediate action required for: ${{ github.event.client_payload.title }}"
          # Add critical bug handling:
          # - Send urgent notifications
          # - Create incident
          # - Page on-call engineer

  # Job 3: Sync status back to Linear
  update-linear:
    runs-on: ubuntu-latest
    if: always()
    needs: [process-claude-ready]
    steps:
      - name: Update Linear issue
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ISSUE_ID: ${{ github.event.client_payload.issueId }}
          BRANCH_NAME: ${{ needs.process-claude-ready.outputs.branch_name }}
          PR_URL: ${{ needs.process-claude-ready.outputs.pr_url }}
          PR_NUMBER: ${{ needs.process-claude-ready.outputs.pr_number }}
        run: |
          echo "📝 Updating Linear issue status"
          
          # Check if LINEAR_API_KEY is set
          if [ -z "$LINEAR_API_KEY" ]; then
            echo "⚠️ LINEAR_API_KEY is not set. Skipping Linear update."
            exit 0
          fi
          
          # First, get the issue's internal ID and current labels
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            https://api.linear.app/graphql \
            -d "{
              \"query\": \"query { issue(id: \\\"$ISSUE_ID\\\") { id labels { nodes { id name } } } }\"
            }")
          
          # Extract the issue's internal ID
          INTERNAL_ID=$(echo "$RESPONSE" | jq -r '.data.issue.id')
          
          if [ "$INTERNAL_ID" != "null" ] && [ -n "$INTERNAL_ID" ]; then
            echo "Found issue with internal ID: $INTERNAL_ID"
            
            # Get all label IDs except "Ready for Claude"
            LABEL_IDS=$(echo "$RESPONSE" | jq -r '.data.issue.labels.nodes[] | select(.name != "Ready for Claude" and .name != "ready for Claude") | .id' | jq -R -s -c 'split("\n")[:-1]')
            
            echo "Keeping labels: $LABEL_IDS"
            
            # Update the issue to remove "Ready for Claude" label and add "In Progress"
            UPDATE_RESPONSE=$(curl -s -X POST \
              -H "Authorization: $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.linear.app/graphql \
              -d "{
                \"query\": \"mutation { issueUpdate(id: \\\"$INTERNAL_ID\\\", input: { labelIds: $LABEL_IDS }) { success issue { labels { nodes { name } } } } }\"
              }")
            
            echo "Label update response: $UPDATE_RESPONSE"
            
            # Add a comment with the PR information
            COMMENT_RESPONSE=$(curl -s -X POST \
              -H "Authorization: $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.linear.app/graphql \
              -d "{
                \"query\": \"mutation { commentCreate(input: { issueId: \\\"$INTERNAL_ID\\\", body: \\\"🤖 GitHub Action processed this issue\\n\\nPull Request: $PR_URL\\nBranch: \`$BRANCH_NAME\`\\n\\nThe PR has been created and Claude has been mentioned to implement the changes. The 'Ready for Claude' label has been removed.\\n\\nNext steps:\\n1. Check out the branch locally\\n2. Review the PR comments where @claude has been mentioned\\n3. Claude Code will implement the changes\\n4. Push changes to the PR\\\" }) { success } }\"
              }")
            
            echo "Comment creation response: $COMMENT_RESPONSE"
          else
            echo "⚠️ Could not find Linear issue with ID: $ISSUE_ID"
            echo "API Response: $RESPONSE"
          fi

  # Job 4: Debug - Show all received data
  debug-payload:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload != '' }}
    steps:
      - name: Display Linear payload
        run: |
          echo "🔍 Debug: Linear Issue Data"
          echo "=========================="
          echo ""
          echo "📋 Full Payload:"
          echo '${{ toJson(github.event.client_payload) }}' | jq '.'
          echo ""
          echo "📌 Key Fields:"
          echo "- Issue ID: ${{ github.event.client_payload.issueId }}"
          echo "- Title: ${{ github.event.client_payload.title }}"
          echo "- Team: ${{ github.event.client_payload.team }}"
          echo "- Priority: P${{ github.event.client_payload.priority }}"
          echo "- Estimate: ${{ github.event.client_payload.estimate }}"
          echo "- Type: ${{ github.event.client_payload.sections.type }}"
          echo "- URL: ${{ github.event.client_payload.url }}"
          echo ""
          echo "🏷️ Labels:"
          echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'
          echo ""
          echo "📝 Description:"
          echo "${{ github.event.client_payload.description }}"