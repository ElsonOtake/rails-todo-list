# .github/workflows/linear-integration.yml
name: Linear Integration Workflow

# This workflow is triggered by repository dispatch events from Linear via n8n
on:
  repository_dispatch:
    types: 
      - linear_to_github_issue_event  # Create GitHub issue from Linear
      - linear_to_github_pr_event     # Create GitHub PR from Linear
      - linear_issue_created   # When new issue is created
      - linear_issue_updated   # When issue is updated
      - linear_issue_completed # When issue is marked complete

jobs:
  # Job 1: Process issues with "Ready for Claude" label for GitHub Issues
  process-claude-ready:
    if: |
      github.event.action == 'linear_to_github_issue_event' &&
      contains(github.event.client_payload.labels, 'Ready for Claude')
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
      issue_url: ${{ steps.create-issue.outputs.issue_url }}
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
        
      - name: Create refactoring branch
        id: create-branch
        run: |
          echo "üìù Processing Linear issue for Claude"
          echo "Issue: ${{ github.event.client_payload.title }}"
          echo "ID: ${{ github.event.client_payload.issueId }}"
          
          # Extract team prefix and create branch name
          TEAM="${{ github.event.client_payload.team }}"
          ISSUE_ID="${{ github.event.client_payload.issueId }}"
          # Take first 8 chars of UUID for shorter branch name
          SHORT_ID="${ISSUE_ID:0:8}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create branch name based on issue type
          LABELS='${{ toJson(github.event.client_payload.labels) }}'
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          
          if [[ "$LABELS" == *"Bug"* ]] || [[ "$LABELS" == *"bug"* ]] || [[ "$ISSUE_TYPE" == "bug" ]]; then
            BRANCH_NAME="fix/${TEAM,,}-${SHORT_ID}"
          elif [[ "$LABELS" == *"feature"* ]] || [[ "$LABELS" == *"Feature"* ]] || [[ "$ISSUE_TYPE" == "feature" ]]; then
            BRANCH_NAME="feature/${TEAM,,}-${SHORT_ID}"
          else
            BRANCH_NAME="refactor/${TEAM,,}-${SHORT_ID}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Fetch all branches to ensure we have latest state
          git fetch origin
          
          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "Branch $BRANCH_NAME exists remotely, fetching and resetting"
            git fetch origin "$BRANCH_NAME":"$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git reset --hard origin/main
            git branch --set-upstream-to=origin/"$BRANCH_NAME" "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi
          
      - name: Create placeholder file for issue tracking
        run: |
          # Create a simple placeholder file to have something to commit
          cat > .linear-issue-${{ github.event.client_payload.issueId }}.md << 'EOF'
          # Linear Issue: ${{ github.event.client_payload.title }}
          
          **Issue ID**: ${{ github.event.client_payload.issueId }}
          **Branch**: ${{ steps.create-branch.outputs.branch_name }}
          **Created**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          This file tracks the Linear issue in the git history.
          The actual issue content is in the GitHub issue.
          EOF
          
          echo "‚úÖ Created placeholder file"
          
      - name: Commit and push branch
        run: |
          git add .linear-issue-*.md
          git commit -m "Add Linear issue ${{ github.event.client_payload.issueId }} for implementation
          
          Issue: ${{ github.event.client_payload.title }}
          Team: ${{ github.event.client_payload.team }}
          Priority: P${{ github.event.client_payload.priority }}
          Labels: ${{ join(github.event.client_payload.labels, ', ') }}"
          
          git push --force origin ${{ steps.create-branch.outputs.branch_name }}
          
      - name: Create GitHub issue
        id: create-issue
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Determine issue type and create appropriate content
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          LABELS='${{ toJson(github.event.client_payload.labels) }}'
          
          if [[ "$ISSUE_TYPE" == "bug" ]] || [[ "$LABELS" == *"Bug"* ]] || [[ "$LABELS" == *"bug"* ]]; then
            ISSUE_BODY="# üêõ Bug Fix: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **Linear ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: P${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          - **Branch**: \`${{ steps.create-branch.outputs.branch_name }}\`
          
          ## Bug Report
          
          ### Current Behavior
          ${{ github.event.client_payload.sections.currentBehavior }}
          
          ### Expected Behavior
          ${{ github.event.client_payload.sections.expectedBehavior }}
          
          ### Steps to Reproduce
          ${{ github.event.client_payload.sections.stepsToReproduce }}
          
          ### Technical Details
          - **Component**: ${{ github.event.client_payload.sections.component }}
          - **Browser/Environment**: ${{ github.event.client_payload.sections.environment }}
          - **Priority**: ${{ github.event.client_payload.sections.priority }}
          
          ### Proposed Solution
          ${{ github.event.client_payload.sections.proposedSolution }}
          
          ---
          *This issue was automatically created from Linear issue ${{ github.event.client_payload.issueId }}*"
          
          elif [[ "$ISSUE_TYPE" == "feature" ]] || [[ "$LABELS" == *"feature"* ]] || [[ "$LABELS" == *"Feature"* ]]; then
            ISSUE_BODY="# ‚ú® Feature Implementation: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **Linear ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: P${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          - **Branch**: \`${{ steps.create-branch.outputs.branch_name }}\`
          
          ## Feature Request
          
          ### Description
          ${{ github.event.client_payload.description }}
          
          ### Requirements
          ${{ github.event.client_payload.sections.requirements }}
          
          ### Technical Details
          ${{ github.event.client_payload.sections.technicalDetails }}
          
          ### Acceptance Criteria
          ${{ github.event.client_payload.sections.acceptanceCriteria }}
          
          ---
          *This issue was automatically created from Linear issue ${{ github.event.client_payload.issueId }}*"
          
          else
            # Default template
            ISSUE_BODY="# Linear Issue: ${{ github.event.client_payload.title }}
          
          ## Issue Details
          - **Linear ID**: ${{ github.event.client_payload.issueId }}
          - **Team**: ${{ github.event.client_payload.team }}
          - **Priority**: P${{ github.event.client_payload.priority }}
          - **Estimate**: ${{ github.event.client_payload.estimate }} points
          - **Linear URL**: ${{ github.event.client_payload.url }}
          - **Branch**: \`${{ steps.create-branch.outputs.branch_name }}\`
          
          ## Description
          ${{ github.event.client_payload.description }}
          
          ## Additional Information
          ${{ toJson(github.event.client_payload.sections) }}
          
          ---
          *This issue was automatically created from Linear issue ${{ github.event.client_payload.issueId }}*"
          fi
          
          ISSUE_URL=$(gh issue create \
            --title "[${{ github.event.client_payload.team }}] ${{ github.event.client_payload.title }}" \
            --body "$ISSUE_BODY" \
            --label "linear-integration" \
            --label "needs-claude")
          
          echo "Issue created: $ISSUE_URL"
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          
          # Extract issue number from URL
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
      

  # Job 2: Handle bug issues specifically
  handle-bugs:
    if: contains(github.event.client_payload.labels, 'Bug')
    runs-on: ubuntu-latest
    steps:
      - name: Process bug report
        run: |
          echo "üêõ Bug Report Received"
          echo "Title: ${{ github.event.client_payload.title }}"
          echo "Priority: P${{ github.event.client_payload.priority }}"
          echo "Team: ${{ github.event.client_payload.team }}"
          
          # Add bug-specific processing here
          # - Create bug tracking issue
          # - Notify team
          # - Run diagnostic tests
          
      - name: Check if critical bug
        if: github.event.client_payload.priority == 1
        run: |
          echo "‚ö†Ô∏è CRITICAL BUG DETECTED!"
          echo "Immediate action required for: ${{ github.event.client_payload.title }}"
          # Add critical bug handling:
          # - Send urgent notifications
          # - Create incident
          # - Page on-call engineer

  # Job 3: Sync status back to Linear (for both issue and PR flows)
  update-linear:
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.comment-on-issue.result == 'success' || needs.comment-on-issue.result == 'skipped' || 
       needs.comment-on-pr.result == 'success' || needs.comment-on-pr.result == 'skipped')
    needs: [process-claude-ready, process-linear-pr, comment-on-issue, comment-on-pr]
    steps:
      - name: Update Linear issue
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          ISSUE_ID: ${{ github.event.client_payload.issueId }}
          BRANCH_NAME: ${{ needs.process-claude-ready.outputs.branch_name || needs.process-linear-pr.outputs.branch_name }}
          ISSUE_URL: ${{ needs.process-claude-ready.outputs.issue_url }}
          PR_URL: ${{ needs.process-linear-pr.outputs.pr_url }}
          ISSUE_NUMBER: ${{ needs.process-claude-ready.outputs.issue_number }}
          PR_NUMBER: ${{ needs.process-linear-pr.outputs.pr_number }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          echo "üìù Updating Linear issue status"
          
          # Check if LINEAR_API_KEY is set
          if [ -z "$LINEAR_API_KEY" ]; then
            echo "‚ö†Ô∏è LINEAR_API_KEY is not set. Skipping Linear update."
            exit 0
          fi
          
          # First, get the issue's internal ID and current labels
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            https://api.linear.app/graphql \
            -d "{
              \"query\": \"query { issue(id: \\\"$ISSUE_ID\\\") { id labels { nodes { id name } } } }\"
            }")
          
          # Extract the issue's internal ID
          INTERNAL_ID=$(echo "$RESPONSE" | jq -r '.data.issue.id')
          
          if [ "$INTERNAL_ID" != "null" ] && [ -n "$INTERNAL_ID" ]; then
            echo "Found issue with internal ID: $INTERNAL_ID"
            
            # Get all label IDs except "Ready for Claude"
            LABEL_IDS=$(echo "$RESPONSE" | jq -r '.data.issue.labels.nodes[] | select(.name != "Ready for Claude" and .name != "ready for Claude") | .id' | jq -R -s -c 'split("\n")[:-1]')
            
            echo "Keeping labels: $LABEL_IDS"
            
            # Update the issue to remove "Ready for Claude" label
            UPDATE_RESPONSE=$(curl -s -X POST \
              -H "Authorization: $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.linear.app/graphql \
              -d "{
                \"query\": \"mutation { issueUpdate(id: \\\"$INTERNAL_ID\\\", input: { labelIds: $LABEL_IDS }) { success issue { labels { nodes { name } } } } }\"
              }")
            
            echo "Label update response: $UPDATE_RESPONSE"
            
            # Prepare comment based on event type
            if [ "$EVENT_ACTION" == "linear_to_github_pr_event" ]; then
              COMMENT_BODY="ü§ñ GitHub Action processed this issue\\n\\nGitHub PR: $PR_URL\\nBranch: \`$BRANCH_NAME\`\\n\\nThe GitHub PR has been created and Claude will be mentioned to implement the feature. The 'Ready for Claude' label has been removed.\\n\\nNext steps:\\n1. Check out the branch locally\\n2. Review the GitHub PR where @claude will be mentioned\\n3. Claude Code will implement the changes\\n4. Review and merge the PR"
            else
              COMMENT_BODY="ü§ñ GitHub Action processed this issue\\n\\nGitHub Issue: $ISSUE_URL\\nBranch: \`$BRANCH_NAME\`\\n\\nThe GitHub issue has been created and Claude will be mentioned to implement the changes. The 'Ready for Claude' label has been removed.\\n\\nNext steps:\\n1. Check out the branch locally\\n2. Review the GitHub issue where @claude will be mentioned\\n3. Claude Code will implement the changes\\n4. Create a PR with the changes"
            fi
            
            # Add a comment with the GitHub information
            COMMENT_RESPONSE=$(curl -s -X POST \
              -H "Authorization: $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.linear.app/graphql \
              -d "{
                \"query\": \"mutation { commentCreate(input: { issueId: \\\"$INTERNAL_ID\\\", body: \\\"$COMMENT_BODY\\\" }) { success } }\"
              }")
            
            echo "Comment creation response: $COMMENT_RESPONSE"
          else
            echo "‚ö†Ô∏è Could not find Linear issue with ID: $ISSUE_ID"
            echo "API Response: $RESPONSE"
          fi

  # Job 4: Add Claude comment to the created GitHub issue
  comment-on-issue:
    runs-on: ubuntu-latest
    if: needs.process-claude-ready.outputs.issue_number != ''
    needs: [process-claude-ready]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Add Claude comment to issue
        env:
          GITHUB_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.process-claude-ready.outputs.issue_number }}
        run: |
          echo "üìù Adding Claude comment to GitHub issue #$ISSUE_NUMBER"
          
          # Determine the appropriate message based on issue type
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          LABELS='${{ toJson(github.event.client_payload.labels) }}'
          
          if [[ "$ISSUE_TYPE" == "bug" ]] || [[ "$LABELS" == *"Bug"* ]] || [[ "$LABELS" == *"bug"* ]]; then
            COMMENT_BODY="@claude Fix this bug based on the issue description above"
          elif [[ "$ISSUE_TYPE" == "feature" ]] || [[ "$LABELS" == *"feature"* ]] || [[ "$LABELS" == *"Feature"* ]]; then
            COMMENT_BODY="@claude Implement this feature based on the issue description and requirements above"
          else
            COMMENT_BODY="@claude Implement this based on the issue description above"
          fi
          
          gh issue comment $ISSUE_NUMBER --body "$COMMENT_BODY"
          echo "‚úÖ Added Claude comment to issue #$ISSUE_NUMBER"

  # Job 5: Debug - Show all received data
  debug-payload:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload != '' }}
    steps:
      - name: Display Linear payload
        run: |
          echo "üîç Debug: Linear Issue Data"
          echo "=========================="
          echo ""
          echo "üìã Full Payload:"
          echo '${{ toJson(github.event.client_payload) }}' | jq '.'
          echo ""
          echo "üìå Key Fields:"
          echo "- Issue ID: ${{ github.event.client_payload.issueId }}"
          echo "- Title: ${{ github.event.client_payload.title }}"
          echo "- Team: ${{ github.event.client_payload.team }}"
          echo "- Priority: P${{ github.event.client_payload.priority }}"
          echo "- Estimate: ${{ github.event.client_payload.estimate }}"
          echo "- Type: ${{ github.event.client_payload.sections.type }}"
          echo "- URL: ${{ github.event.client_payload.url }}"
          echo ""
          echo "üè∑Ô∏è Labels:"
          echo '${{ toJson(github.event.client_payload.labels) }}' | jq -r '.[]'
          echo ""

  # Job 7: Process Linear PR creation events
  process-linear-pr:
    if: |
      github.event.action == 'linear_to_github_pr_event' && 
      contains(github.event.client_payload.labels, 'Ready for Claude')
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create and setup branch
        id: create-branch
        run: |
          # Extract issue ID and team from Linear data
          ISSUE_ID="${{ github.event.client_payload.issueId }}"
          TEAM="${{ github.event.client_payload.team }}"
          SHORT_ID=$(echo "$ISSUE_ID" | cut -d'-' -f1-2)
          
          # Determine branch name based on issue type
          ISSUE_TYPE="${{ github.event.client_payload.sections.type }}"
          LABELS='${{ toJson(github.event.client_payload.labels) }}'
          
          if [[ "$ISSUE_TYPE" == "bug" ]] || [[ "$LABELS" == *"Bug"* ]] || [[ "$LABELS" == *"bug"* ]]; then
            BRANCH_NAME="fix/${TEAM,,}-${SHORT_ID}"
          elif [[ "$ISSUE_TYPE" == "feature" ]] || [[ "$LABELS" == *"feature"* ]] || [[ "$LABELS" == *"Feature"* ]]; then
            BRANCH_NAME="feature/${TEAM,,}-${SHORT_ID}"
          else
            BRANCH_NAME="refactor/${TEAM,,}-${SHORT_ID}"
          fi
          
          echo "Branch name: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Fetch all branches to ensure we have latest state
          git fetch origin
          
          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "Branch $BRANCH_NAME exists remotely, fetching and resetting"
            git fetch origin "$BRANCH_NAME":"$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git reset --hard origin/main
            git branch --set-upstream-to=origin/"$BRANCH_NAME" "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi
          
      - name: Create placeholder file for PR
        run: |
          # Create a placeholder file to have something to commit
          ISSUE_ID="${{ github.event.client_payload.issueId }}"
          SHORT_ID=$(echo "$ISSUE_ID" | cut -d'-' -f1-2)
          
          cat > .linear-pr-${SHORT_ID}.md << 'EOF'
          # Linear Issue: ${{ github.event.client_payload.title }}
          
          **Issue ID**: ${{ github.event.client_payload.issueId }}
          **Team**: ${{ github.event.client_payload.team }}
          **Priority**: P${{ github.event.client_payload.priority }}
          **Linear URL**: ${{ github.event.client_payload.url }}
          
          ## Description
          ${{ github.event.client_payload.description }}
          
          ---
          *This file was auto-generated from Linear and will be removed when the implementation is complete.*
          EOF
          
          git add .linear-pr-*.md
          git commit -m "Add Linear issue ${{ github.event.client_payload.issueId }} for implementation"
          
      - name: Push branch
        run: |
          git push --force origin ${{ steps.create-branch.outputs.branch_name }}

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare PR body with template
          PR_BODY=$(cat <<'EOF'
          ## O que esse PR faz?
          
          ${{ github.event.client_payload.description }}
          
          ---
          
          **Linear Issue**: [${{ github.event.client_payload.title }}](${{ github.event.client_payload.url }})
          **Issue ID**: ${{ github.event.client_payload.issueId }}
          **Team**: ${{ github.event.client_payload.team }}
          **Priority**: P${{ github.event.client_payload.priority }}
          
          ## Tipo de mudan√ßa
          
          [//]: # 'Apague o que n√£o for relevante.'
          
          - [ ] Bug (corre√ß√£o)
          - [ ] Nova funcionalidade (cria uma nova funcionalidade para o cliente)
          - [ ] Mudan√ßa de funcionalidade (muda a forma como uma funcionalidade atual funciona)
          
          ## Checklist:
          
          - [ ] Atualizei a planilha de permiss√µes de usu√°rios ([RBAC](https://docs.google.com/spreadsheets/d/1GkAj7nF1M7T3ggCvbGlsjvsUYGgT8OkFZU0L_dF1ka8/edit?gid=0#gid=0))
          - [ ] Atualizei a planilha de suporte a provedores financeiros oferecido pela Kobana ([SPRF](https://docs.google.com/spreadsheets/d/1NkceBPXPufOhz4lRZiGF03bV_fEtTQ6uaIwUhIYdKZg/edit?pli=1&gid=0#gid=0))
          - [ ] Adicionei novo campo/model no manage/admin
          - [ ] Adicionei novo campo/model no spec/swaggers para documentar na API
          - [ ] Notifiquei o suporte sobre mudan√ßa no menu de acesso dos clientes (Ordem, Nome, Local)
          - [ ] Precisa de atualiza√ß√µes nas documenta√ß√µes e tutoriais
          - [ ] Precisa rodar uma tarefa(app/tasks) ap√≥s o deploy
          
          ## Screenshots:
          EOF
          )
          
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "${{ steps.create-branch.outputs.branch_name }}" --json number,url --jq '.[0]')
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR already exists for branch ${{ steps.create-branch.outputs.branch_name }}"
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
            echo "Using existing PR #$PR_NUMBER: $PR_URL"
            
            # Update the PR body with the new template
            gh pr edit $PR_NUMBER --body "$PR_BODY"
            echo "Updated PR body with latest template"
          else
            # Create new PR
            PR_TITLE="${{ github.event.client_payload.title }}"
            
            gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "${{ steps.create-branch.outputs.branch_name }}"
            
            # Get PR number and URL
            PR_INFO=$(gh pr list --head "${{ steps.create-branch.outputs.branch_name }}" --json number,url --jq '.[0]')
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
            PR_URL=$(echo "$PR_INFO" | jq -r '.url')
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Created PR #$PR_NUMBER: $PR_URL"

  # Job 8: Add Claude comment to PR
  comment-on-pr:
    if: needs.process-linear-pr.result == 'success'
    needs: [process-linear-pr]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Add Claude comment to PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.process-linear-pr.outputs.pr_number }}
          BRANCH_NAME: ${{ needs.process-linear-pr.outputs.branch_name }}
        run: |
          # If PR_NUMBER is empty, try to find it from the branch
          if [ -z "$PR_NUMBER" ]; then
            echo "PR_NUMBER is empty, trying to find PR from branch $BRANCH_NAME"
            PR_INFO=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            if [ -n "$PR_INFO" ]; then
              PR_NUMBER="$PR_INFO"
              echo "Found PR #$PR_NUMBER for branch $BRANCH_NAME"
            else
              echo "‚ùå Could not find PR for branch $BRANCH_NAME"
              exit 1
            fi
          fi
          
          echo "üìù Adding Claude comment to PR #$PR_NUMBER"
          
          COMMENT_BODY="@claude implement this feature based on the PR description"
          
          gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
          echo "‚úÖ Added Claude comment to PR #$PR_NUMBER"

